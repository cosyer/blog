---
title: 实现一个网页终端
tags:
  - JS
copyright: true
comments: true
date: 2020-12-08 20:36:30
categories: 知识
photos:
---

先简单说一下原理吧，在网页上和服务器上建立一个 ws 连接，然后网页获取用户输入传给服务端，服务端解析用户输入，在服务端 shell 执行命令并将执行输出通过 ws 传给网页渲染到页面上。

以上原理说起来简单，但是完全自己实现是不太现实的。下面我把实现用到的库和插件以及使用方式简单说一下。

---

<!--more-->

## xterm.js

xterm.js 是一个用来实现网页上终端 UI 的库。

简单的使用示例：

```html
<div id="terminal"></div>
<script>
  var terminalIns = new Terminal();
  terminalIns.open(document.getElementById("terminal"));
  terminalIns.write("Hello from \x1B[1;3;31mxterm.js\x1B[0m $ ");
</script>
```

## node-pty

node-pty 是在 node.js 上用户执行 shell 命令，并获取标准输出的仓库，可以配合 xterm.js 通过 ws 来实现远程终端。

```js
var os = require("os");
var pty = require("node-pty");

var shell = os.platform() === "win32" ? "powershell.exe" : "bash";

var ptyProcess = pty.spawn(shell, [], {
  name: "xterm-color",
  cols: 80,
  rows: 30,
  cwd: process.env.HOME,
  env: process.env,
});

ptyProcess.on("data", function (data) {
  process.stdout.write(data);
});

ptyProcess.write("ls\r");
ptyProcess.resize(100, 40);
ptyProcess.write("ls\r");
```

## sockjs

sockjs 这个没啥好说的，实现 WebSocket 的库。

```js
const http = require("http");
const sockjs = require("sockjs");

const echo = sockjs.createServer({ prefix: "/echo" });
echo.on("connection", function (conn) {
  conn.on("data", function (message) {
    conn.write(message);
  });
  conn.on("close", function () {});
});

const server = http.createServer();
echo.attach(server);
server.listen(9999, "0.0.0.0");
```

## 实现流程

1. 在服务端通过 sockjs 起一个 ws 的服务
2. 并实例化 node-pty 通过 sockjs 的 ws 服务来接受客户端的命令执行并将反馈通过 ws 输出到客户端
3. 在网页端通过 xterm.js 初始化一个网页终端 UI
4. 将网页端的 xterm.js 实例与服务端的 node-pty 建立连接，这里需要用到 xterm.js 的一个插件 xterm-addon-attach 这个插件接受一个 WebSocket 实例作为参数与服务端建立连接
